---
layout:     post
title:      关于微信红包的一些思考(二) 
subtitle:   Making it rain
date:       2019-04-21
author:     唐瑞甫
header-img: img/post-bg-coffee.jpeg
catalog: true
tags: 
    - 分布式

---  

上篇文章站在算法实现以及流程设计的角度对微信红包的出发点进行了一定的思考。再次声明，**文中所给出的实现并非微信官方的实现**。只是尽可能在大方向保持正确的前提下，希望能尽可能多地摸索出一些细节。  
  
文章最后，提出了一个小小的思考，为什么偶尔还是会出现抢到红包了但是里面却是空的呢？为什么不在抢红包的时候就做到严格的过滤呢？
  
  

### 流程的背后是什么 
  
上面这个问题其实还是之前说的流程，将抢红包的过程拆分成现在的抢跟拆两步之后，实际上也以为着抢到红包不一定是真的抢到了，不然就没有必要拆成两步了。这里的抢其实可以理解成**抢到的是拆红包的资格**。  
  
增加了拆红包的操作，其实是增加了一层过滤，可以降低对数据的访问，减轻数据层的压力。在高并发的场景中，即使增加了过滤，仍然会出现冲突的情况，这也会导致抢到红包拆开为空的情况，具体冲突的场景，下文会有详细的说明。  
  
从体验上来讲，一步变两步以后，需要“拼手速“能够增加这个游戏的刺激性，提升用户的游戏体验。这里暂且先不去关注产品层面的问题，把目光聚焦到具体实现上，在具体的方案设计上，如何满足这个流程的需求？  
  
有以下几点是目前就可以确定的：  

1. 不管是多线程/多线程/多协程的环境中，红包算法中涉及到金额相关的操作会用 [CAS](https://en.wikipedia.org/wiki/Compare-and-swap) 来进行处理。  
2. 以目前的并发来看，后端不会直接用 DB 来直接扛流量，而是前面会挂一层 Cache 来存储数据。这里的 Cache 指的是 Cache 中间件，例如 Memcached 这种，而不是内存cache。  
  
由于数据会从 Cache 或者 DB 中读取，所以**没法直接用原子操作**，而一些 Cache 中间件则是可以直接支持 CAS 的。在该场景中利用 CAS 语义甚至都不用去考虑 [ABA](https://en.wikipedia.org/wiki/ABA_problem) 这种问题。那么基于这两点，整个发红包抢红包的方案应该如何设计？  
  
#### 发红包  
  
首先是发红包的过程，这个过程看似比较简单，就是新增一条记录，这条记录涉及到两个关键的值，红包的剩余个数跟剩余金额。从设计角度来讲，这一步其实很关键，而且有一些细节需要处理好，不然会影响后面的整个流程。这个看似简单的插入过程有以下几个细节需要确认：  
  
1. 新增一条记录还是新增两条记录(剩余个数跟剩余金额存在一条记录还是两条记录)  
2. 存在 Cache 中还是存在 DB中(全入 Cache，全入 DB，还是部分 Cache 部分 DB)  
  
上面这两点其实本质上是在解决一个问题，**关键数据如何存放**。  
  
先来看下为什么需要 Cache 层？**防止请求量过大拖垮 DB**。从两个角度来理解：  
    
1. 通过设置阈值来限制请求量，通过 CAS 操作当该值减少至 0 时，拒绝连接 DB 的请求。  
2. 将一部分需要直接存放在 DB 中的值存放在 Cache 中，后续在异步地将数据同步到 DB 中。  
  
由于是金融交易，会涉及到资金的入账出账，所以发红包这个过程一定会在 DB 中新增一条记录。其中包含了红包 ID，累积金额，累积数量，总金额，总数量，发红包的用户信息，时间等数据。同时会将金额及数量这种关键信息写入到 Cache 中。  
  
这里需要考虑到 写 Cache 失败的场景，会有失败重试的逻辑，以及极特殊情况下 Cache 挂掉，则绕过 Cache 从 DB 中获取数据。  
   
#### 抢红包  
  
抢红包的过程其实就是判断 Cache 中剩余红包个数是否为 0。这里需要注意的一点是，该操作**不需要读取即时数据**。换句话讲，比如现在最后一个红包被拆了，需要更新红包剩余个数，与此同时，有个抢红包的请求过来，需要读取红包剩余个数。这时如果需要保证实时性，则需要通过加锁或者排队等方式来保证读写互斥。  
  
这就是上文所说的产生冲突的场景，会导致用户抢到了红包拆开却为空。因为这里如果需要严格互斥的话必然会增加时延，而没有严格互斥所产生的影响只是少部分用户抢到了红包拆开却为空的情况，这种情况本身就是存在的。即使让这小部分用户通过，也并不会明显增加系统的访问量，毕竟冲突产生的几率是很小的。  
  
#### 拆红包  
  
拆红包的过程可以分为以下几步：
    
1. CAS 更新 Cache  
2. DB 中 insert 拆红包的流水明细，并 update 该条红包记录  
  
对于第一点，其实就是读取 Cache 中的值并利用上篇文章中给出的算法算出随机红包的金额值，对 Cache 进行 CAS 操作。**CAS操作失败了会有重试的逻辑**，对应的是场景是现实生活中拆红包的过程有时候那个金币会转一会，而没有立马显示金额，其实就是同一时刻多个人拆红包的时候，会出现 CAS 失败然后重试的情况。  
  
对于第二点，在数据库中记录流水明细显然是必要的，这里的 insert 跟 update 的过程需要放在**同一个事务**中，需要 insert 的是拆出来单个红包的信息，包括金额，时间，用户信息等，而 update 的则是发红包对应的那条红包记录，需要 update 的字段包括 累积金额，累积数量，更新时间等。需要注意的是入账为**异步操作**，这也是为什么过年期间拆出红包后用户账户金额没有增加的原因。  
  
### 关于架构  
  
之前看过微信红包**官方对于微信红包架构设计的一些分享**，有很多值得学习和借鉴的地方，这里也推荐跟大家。  
  
  [百亿级微信红包的高并发资金交易系统设计方案](https://www.infoq.cn/article/2017hongbao-weixin)  
    
虽然是17年的分享，但是有很多地方都是通用的，比如 **SET 化、请求排队串行化、双维度分库表等设计**都非常值得深入研究。也欢迎大家能和我一起讨论分布式相关的一些技术。

  
  
---
  By 唐瑞甫  
  2019-04-14

